<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<STYLE type="text/css">
<!--
textarea {
max-width:400px;
max-height:100px;
}
-->
</STYLE>
<title>みりますRTB計算</title>
</head>
<body>
<!--日付変更にmomentjisを使用、ろーかるで動かすにはhttp://momentjs.com/　が必要-->
<script type="text/javascript" src="./LIB/moment-with-langs.js"></script>
<script type="text/javascript">
<!--
	var RTBs = function (_t,_a,_b,_c,_d,_e) {
		this.t=  _t;
		this.a = _a;
		this.b = _b;
		this.c = _c;
		this.d = _d;
		this.e = _e;
	};
	
	function stringfilter(text){
	
	var RTB = [];//１日分なら配列1500ぐらい,いべ最大13日*24時間*60分=配列18720,dt　int5が8+4*5とするとMAXで524,160+TXT分
	var rt= document.trg.event.options[document.trg.event.selectedIndex].text;
	var tf=document.tt.time.options[document.tt.time.selectedIndex].text;
	var tf2=document.DD.dy.options[document.DD.dy.selectedIndex].text;
	var BYEAR=document.YN.yn.options[document.YN.yn.selectedIndex].text;
	var BYEARN="";
	var tosikosi=false;
	if(text.indexOf("※12/31")>0 && text.indexOf("※01/01")>0 ){
	 tosikosi = true;
	var bym =BYEAR.match(/-?\d+/);
	if(bym!=null){
	var y=parseInt(bym[0]);
	 BYEARN=String(y+1);
	 }
	}
	var TYEAR=BYEAR+"/";
	
	if(document.DD.dy.selectedIndex>0){
	var tfs= tf.split("HH");
	tf=tfs[0]+tf2+" HH"+tfs[1];
	}
	
	if(tf==null){
	tf="YYYY/MM/DD HH:mm"
	}
	
	if(document.trg.event.selectedIndex>0){
	text=text.replace(new RegExp(rt, 'g'), "XX:XX");
	}
	
	//泥の標準ぶらうざだと改行ぬけるので対策、else配列=-4は廃止
	text=text.replace(new RegExp("[ 　\t]+pt[ 　\t]+","gm")," pt\n");
	
	var lf = text.split("\n");
	var str ="";
	var st="";
	var btmp=[0,0,0,0,0];
	var head=new Array("1位","100位","1200位","3000位","自速");
	
    regrank = new RegExp("(1|[0-9]+0)位[ 　\t]+([0-9]+(,[0-9]{3})*)[ 　\t]+pt");
    regownpace = new RegExp(".*?pt[ 　\t]+([0-9]+(,[0-9]{3})*)[ 　\t]+pt");
    rgr = new RegExp("([0-9]+0?位.*?\n)+※");
    regdt = new RegExp("※([0-9]{2}/[0-9]{2}).*?([0-9]{2}:[0-9]{2}) 集計時点");
    var k=0,t=-4;
	
	var matches = text.match(rgr);
	if(matches !=null){
	//なんとか位を拾う
	var mm=matches[0].match(/[0-9]+位/gm)
	for(var i=0;i<mm.length;i++){
	head[i]=mm[i];
	if(i==3){ break;}
	}
	}

for( var i = 0 , l = lf.length; i < l ; i++ ){
 		str= lf[i];
		if(str.match(regrank)!=null){
		var xx = str.match(regrank);
		if(t<0){
		btmp[t+4]=rmc(xx[2]);
		t++;
		}
		}
		else if(str.match(regownpace)!=null){
		var xx = str.match(regownpace);
		btmp[4]=rmc(xx[1]);
		}
		else if(str.match(regdt)!=null){
		var xx = str.match(regdt);
		
		if(tosikosi==true){
		if(str.indexOf("※01/01")>=0){
		TYEAR=BYEARN+"/";
		}
		else if(str.indexOf("※12/31")>=0){
		TYEAR=BYEAR+"/";
		}
		}
		
		 RTB[k] = new RTBs("",0,0,0,0,0);
		 RTB[k].t= tmcv(TYEAR+"/"+xx[1]+" "+xx[2],tf);
		 RTB[k].a=btmp[0];
		 RTB[k].b=btmp[1];
		 RTB[k].c=btmp[2];
		 RTB[k].d=btmp[3];
		 RTB[k].e=btmp[4];
		 k++;
		 t=-4;
		}
		//else if(str!=null){
		//t=-4; //一部あんどろ用修正で2段改行になりりせっとされてしまうので無効
		//}     //( pt \nのとき→ pt \n\n)
}

	var swap=document.tsort.event.selectedIndex;
	if(document.tsort.event.selectedIndex>0){
	RTB.sort(cmp_dt2);
	}
	else{
	RTB.sort(cmp_dt);
	}
	
	var ch=[];
	var i=0;
	var j=0;
	var l = RTB.length-1;
	for(var i=0;i<5;i++){
	ch[i]=document.chbox.elements[i].checked;
	}
	var ac=document.chbox.elements[5].checked;
	
	var lt=document.getElementById("lim").value;
	var ltm =lt.match(/-?\d+/);
	if(ltm!=null){
		j=parseInt(ltm[0]);
		
		if(swap){
			if(j<0){
			l=-j;
			}
			else{
			l=l-j;
			}
			j=0;
		 if(l<0 || l>RTB.length-1){
		 return document.cvcode.elements[0].value = "エラー,配列数範囲外です START:"+j+"MAX" + (l+1);
		 }
		}
		else{
		 if(j<0){
		 j=l+j;
		 }
		 if(j<0 || j>l){
		 return document.cvcode.elements[0].value = "エラー,配列数範囲外です START:"+j+"MAX" + (l+1);
		 }
		}
	}
	
	
	if(ch[4]){
	st= "\n"+ st + head[4] +"\n";
	if(!swap){
	st = st + RTB[j].t +"\t" + cmsuuji(ac,RTB[j].e) +"\n";
		for(i=j ; i < l ; i++ ){
		if(RTB[i+1].t!=""){
	 	st = st + RTB[i+1].t +"\t" + cmsuuji(ac,RTB[i+1].e) + "(+" + cmsuuji(ac,RTB[i+1].e-RTB[i].e) + ")\n";
	 	}
	 	}
	}
	else if(swap){
		for(i=j ; i < l ; i++ ){
		if(RTB[i].t!=""){
	 	st = st + RTB[i].t +"\t" + cmsuuji(ac,RTB[i].e) + "(+" + cmsuuji(ac,RTB[i].e-RTB[i+1].e) + ")\n";
	 	}
		}
	st = st + RTB[l].t +"\t" + cmsuuji(ac,RTB[l].e) +"\n";
	}
	}
	
	
	if(ch[3]){
	st= "\n"+ st + head[3] +"\n";
	if(!swap){
	st = st + RTB[j].t +"\t" + cmsuuji(ac,RTB[j].d) +"\n";
		for(i=j ; i < l ; i++ ){
		if(RTB[i+1].t!=""){
	 	st = st + RTB[i+1].t +"\t" + cmsuuji(ac,RTB[i+1].d) + "(+" + cmsuuji(ac,RTB[i+1].d-RTB[i].d) + ")\n";
	 	}
	 	}
	}
	else if(swap){
		for(i=j ; i < l ; i++ ){
		if(RTB[i].t!=""){
	 	st = st + RTB[i].t +"\t" + cmsuuji(ac,RTB[i].d) + "(+" + cmsuuji(ac,RTB[i].d-RTB[i+1].d) + ")\n";
	 	}
		}
	st = st + RTB[l].t +"\t" + cmsuuji(ac,RTB[l].d) +"\n";
	}
	}
	
	
	if(ch[2]){
	st= "\n"+ st + head[2] +"\n";
	if(!swap){
	st = st + RTB[j].t +"\t" + cmsuuji(ac,RTB[j].c) +"\n";
		for(i=j ; i < l ; i++ ){
		if(RTB[i+1].t!=""){
	 	st = st + RTB[i+1].t +"\t" + cmsuuji(ac,RTB[i+1].c) + "(+" + cmsuuji(ac,RTB[i+1].c-RTB[i].c) + ")\n";
	 	}
	 	}
	}
	else if(swap){
		for(i=j ; i < l ; i++ ){
		if(RTB[i].t!=""){
	 	st = st + RTB[i].t +"\t" + cmsuuji(ac,RTB[i].c) + "(+" + cmsuuji(ac,RTB[i].c-RTB[i+1].c) + ")\n";
	 	}
		}
	st = st + RTB[l].t +"\t" + cmsuuji(ac,RTB[l].c) +"\n";
	}
	}
	
	
	if(ch[1]){
	st= "\n"+ st + head[1] +"\n";
	if(!swap){
	st = st + RTB[j].t +"\t" + cmsuuji(ac,RTB[j].b) +"\n";
		for(i=j ; i < l ; i++ ){
		if(RTB[i+1].t!=""){
	 	st = st + RTB[i+1].t +"\t" + cmsuuji(ac,RTB[i+1].b) + "(+" + cmsuuji(ac,RTB[i+1].b-RTB[i].b) + ")\n";
	 	}
	 	}
	}
	else if(swap){
		for(i=j ; i < l ; i++ ){
		if(RTB[i].t!=""){
	 	st = st + RTB[i].t +"\t" + cmsuuji(ac,RTB[i].b) + "(+" + cmsuuji(ac,RTB[i].b-RTB[i+1].b) + ")\n";
	 	}
		}
	st = st + RTB[l].t +"\t" + cmsuuji(ac,RTB[l].b) +"\n";
	}
	}
	
	
	if(ch[0]){
	st= "\n"+ st + head[0] +"\n";
	if(!swap){
	st = st + RTB[j].t +"\t" + cmsuuji(ac,RTB[j].a) +"\n";
		for(i=j ; i < l ; i++ ){
		if(RTB[i+1].t!=""){
	 	st = st + RTB[i+1].t +"\t" + cmsuuji(ac,RTB[i+1].a) + "(+" + cmsuuji(ac,RTB[i+1].a-RTB[i].a) + ")\n";
	 	}
	 	}
	}
	else if(swap){
		for(i=j ; i < l ; i++ ){
		if(RTB[i].t!=""){
	 	st = st + RTB[i].t +"\t" + cmsuuji(ac,RTB[i].a) + "(+" + cmsuuji(ac,RTB[i].a-RTB[i+1].a) + ")\n";
	 	}
		}
	st = st + RTB[l].t +"\t" + cmsuuji(ac,RTB[l].a) +"\n";
	}
	}
	
	document.cvcode.elements[0].value = st;
	return false;
	}
	
	//datetimeソート昇順
	function cmp_dt(ldt, rdt) {
	return moment(ldt.t,"YYYY/MM/DD HH:mm") - moment(rdt.t,"YYYY/MM/DD HH:mm");
	}
	
	//datetimeソート降順
	function cmp_dt2(ldt, rdt) {
	return moment(rdt.t,"YYYY/MM/DD HH:mm") - moment(ldt.t,"YYYY/MM/DD HH:mm");
	}
	
	//符号交換
	function swap_cal(c,a){
	return (c)?-a:a;
	}
	
	//カンマ付き数字 TF
	var cmsuuji=function(c,d){
	return  (c!=true) ? d : addc(d);
	}
	
	//正規でカンマつける
	function addc(a){
	return String(a).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,' );
	}
	
	//正規でカンマ除去
	function rmc(a){
	return parseInt(a.replace(new RegExp(",", 'g'), ""));
	}
	
	//momentjsで変換
	function tmcv(dt,tf){
	var m = moment(dt,"YYYY/MM/DD HH:mm");
	if(tf.indexOf("J")>0){//Jなら日本語曜日
	tf=tf.replace("J","");
	m.lang("ja");
	}
	if(tf.indexOf("Ｈ")>0){//Ｈ平成に変換
	tf=tf.replace("Ｈ","YY");
	//m.add('years', -1988);
	
	//http://bizmakoto.jp/bizid/articles/0709/18/news046.html
	//2000年以上限定、1988=2000-12なので2087まで使える？
	m.add('years', 12);
	}
	return m.format(tf);
	}
-->
</script>

<p>いべとっぷのぼだすこあ部分を貼り付け<br>
ぼだ：「個人ランキング獲得ポイント～集計時点のポイント」　まで<br>
自速:「個人ステータス～集計時点の順位」　まで<br>
</p>
<form name="chbox">
//出力対象<br>
<input type="checkbox" value="S1">ランク１<br>
<input type="checkbox" value="S2">ランク２<br>
<input type="checkbox" value="S3">ランク３<br>
<input type="checkbox" value="S4">ランク４<br>
<input type="checkbox" value="OWN">自速<br>
<input type="checkbox" value="ADDC">カンマ付き数字で出力<br>
</form>
<form name="YN">
//開始年<br>
<select name="yn">
<option value="">2014</option>
<option value="">2015</option>
</select>
</form>
<form name="tt">
//日付時刻表記<br>
<select name="time">
<option value="">YYYY/MM/DD HH:mm</option>
<option value="">YYYY-MM-DD HH:mm</option>
<option value="">YYYY年MM月DD日 HH時mm分</option>
<option value="">YY/MM/DD HH:mm</option>
<option value="">YY-MM-DD HH:mm</option>
<option value="">YY年MM月DD日 HH時mm分</option>
<option value="">[H]Ｈ年MM月DD日 HH時mm分</option>
<option value="">平成Ｈ年MM月DD日 HH時mm分</option>
<option value="">MM/DD/YYYY HH:mm</option>
<option value="">MM-DD-YYYY HH:mm</option>
<option value="">MM/DD/YY HH:mm</option>
<option value="">MM/DD/Ｈ HH:mm</option>
<option value="">MM-DD-YY HH:mm</option>
<option value="">MM-DD-Ｈ HH:mm</option>
<option value="">MM/DD HH:mm</option>
<option value="">MM-DD HH:mm</option>
<option value="">MM月DD日 HH時mm分</option>
<option value="">HH:mm</option>
</select>
</form>
<form name="DD">
//曜日表記<br>
<select name="dy">
<option value=""></option>
<option value="">ddd</option>
<option value="">dddd</option>
<option value="">dddJ</option>
<option value="">(ddd)J</option>
<option value="">（ddd）J</option>
<option value="">ddddJ</option>
<option value="">(dddd)J</option>
<option value="">（dddd）J</option>
</select>
</form>
<form name="trg">
//時刻正規<br>
<select name="event">
<option value=""></option>
<option value="">(※5分毎)?[0-9]{2}:[0-5][1-46-9]</option>
<option value="">(※10分毎)?[0-9]{2}:[0-5][1-9]</option>
<option value="">(※20分毎)?[0-9]{2}:([135][0-9]|[024][1-9])</option>
<option value="">(※30分毎)?[0-9]{2}:([1245][0-9]|[03][1-9])</option>
<option value="">(※1時間毎)?[0-9]{2}:(0[1-9]|[1-5][0-9])</option>
<option value="">(※24時間毎,17時起点)?((0[0-9]|1[0-689]|2[0-4]):[0-9][0-9]|17:([1-9][0-9]|0[1-9]))</option>
<option value="">(※24時間毎,0時起点)?((0[1-9]|1[0-9]|2[0-4]):[0-9][0-9]|00:([1-9][0-9]|0[1-9]))</option>
</select>
</form>
<form name="tsort">
//時刻ソート<br>
<select name="event">
<option value="">昇順(古→新)</option>
<option value="">降順(新→古)</option>
</select>
</form>
<form name="output">
//出力行数制限<br>
<input type="text" id="lim" value="0">
</form><br>
<form name="rtbcode">
<textarea name="text" rows="10" cols="100"></textarea><br>
<input type="Submit" value="Convert" Generate" onclick="stringfilter(document.rtbcode.text.value);return false">
<input type="reset" value="Clear">
</form>
<form name="cvcode">
<textarea name="text" rows="10" cols="100"></textarea>
</form>
<p>
更新履歴<br>
2014/04/22<br>
webkit系はフォームが勝手に伸縮できてしまうのでCSSでいじれないように変更<br>
時刻ソートに対応,昇順/降順選択可能<br>
年越しに一応対応(※12/31と※01/01含む場合のみ)<br>
曜日,カンマ付き数字を出力を追加<br>
最初の配列を出力するようにした<br>
出力行数制限を追加,0=全配列,ｘ以上=ｘ～最大数,-ｘ以下=最大数-ｘ～最大数まで<br>
2014/04/21<br>
あんどろいど全般のぶらうざで改行ぬけるっぽいので対策<br>
てーぶるろう〆&lt;/tr&gt;が改行にされないぽい？<br>
2014/04/20<br>
個人ステータ下の自速計算に対応<br>
日付出力に平成を追加<br>
2014/04/19<br>
動作確認済ブラウザりすとを追加<br>
2014/04/17<br>
日付変更を追加、らいぶらりmoment.jsを使用<br>
NETAで作成、C#→JSに移植しただけ<br>
過去いべでたなら<a href="http://millionlive-border-records.googlecode.com/">SVN</a>に存在<br>
by(ﾟ∀ﾟ)えれな道場</p>

//動作確認済ブラウザ//<br>
PC:IE10,FIREFOX,CHROME<br>
iOS:SAFARI<br>
ANDROID:CHROME,改行抜け対策済み非推奨(BROWSERetc)<br>
</body>
</html>